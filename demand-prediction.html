<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GastroTrack - Demand Prediction</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --color-primary: #e14632;
      --color-sidebar: #1f2430;
      --color-sidebar-hover: #2d3341;
      --color-text-primary: #1f2430;
      --color-text-secondary: #6a6a6a;
      --color-bg-main: #f6efe6;
      --color-success: #28a745;
      --color-warning: #ffc107;
      --color-danger: #dc3545;
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 18px;
      --shadow-sm: 0 2px 6px rgba(0,0,0,.06);
      --shadow-md: 0 4px 12px rgba(0,0,0,.1);
      --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-family);
      color: var(--color-text-primary);
      background: var(--color-bg-main);
      line-height: 1.6;
    }

    /* Header */
    .header {
      background: #fff;
      padding: 20px 40px;
      border-bottom: 1px solid #eee;
      box-shadow: var(--shadow-sm);
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1400px;
      margin: 0 auto;
    }

    .header h1 {
      font-size: 24px;
      font-weight: 700;
      color: var(--color-text-primary);
    }

    .back-btn {
      background: var(--color-primary);
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }

    .back-btn:hover {
      background: #c33d2a;
      transform: translateY(-1px);
    }

    /* Main Container */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 40px;
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: white;
      border-radius: var(--radius-md);
      padding: 24px;
      box-shadow: var(--shadow-sm);
      border-left: 4px solid var(--color-primary);
    }

    .stat-card h3 {
      font-size: 14px;
      font-weight: 600;
      color: var(--color-text-secondary);
      margin-bottom: 8px;
      text-transform: uppercase;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 800;
      color: var(--color-text-primary);
    }

    .stat-change {
      font-size: 12px;
      font-weight: 600;
      margin-top: 4px;
    }

    .stat-change.positive {
      color: var(--color-success);
    }

    .stat-change.negative {
      color: var(--color-danger);
    }

    /* Prediction Table */
    .prediction-section {
      background: white;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
      margin-bottom: 40px;
    }

    .section-header {
      background: #f8f9fa;
      padding: 20px 24px;
      border-bottom: 1px solid #eee;
    }

    .section-header h2 {
      font-size: 18px;
      font-weight: 700;
      color: var(--color-text-primary);
    }

    .table-container {
      overflow-x: auto;
    }

    .prediction-table {
      width: 100%;
      border-collapse: collapse;
    }

    .prediction-table th,
    .prediction-table td {
      padding: 16px 20px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    .prediction-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: var(--color-text-secondary);
      font-size: 12px;
      text-transform: uppercase;
    }

    .prediction-table tr:hover {
      background: #f8f9fa;
    }

    .item-name {
      font-weight: 600;
      color: var(--color-text-primary);
    }

    .category-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: var(--radius-sm);
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .category-beverages {
      background: #e3f2fd;
      color: #1976d2;
    }

    .category-food {
      background: #f3e5f5;
      color: #7b1fa2;
    }

    .category-desserts {
      background: #fff3e0;
      color: #f57c00;
    }

    .sales-number {
      font-weight: 600;
      font-size: 16px;
    }

    .prediction-number {
      font-weight: 700;
      font-size: 16px;
    }

    .accuracy-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .accuracy-bar {
      width: 60px;
      height: 6px;
      background: #e9ecef;
      border-radius: 3px;
      overflow: hidden;
    }

    .accuracy-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    .accuracy-high {
      background: var(--color-success);
    }

    .accuracy-medium {
      background: var(--color-warning);
    }

    .accuracy-low {
      background: var(--color-danger);
    }

    .trend-arrow {
      font-size: 18px;
      font-weight: bold;
    }

    .trend-up {
      color: var(--color-success);
    }

    .trend-down {
      color: var(--color-danger);
    }

    .trend-stable {
      color: var(--color-text-secondary);
    }

    /* Chart Section */
    .chart-section {
      background: white;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
      padding: 24px;
    }

    .chart-container {
      position: relative;
      height: 400px;
      margin-top: 20px;
    }

    /* Loading State */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 60px;
      color: var(--color-text-secondary);
    }

    .spinner {
      width: 24px;
      height: 24px;
      border: 2px solid #e9ecef;
      border-top: 2px solid var(--color-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 12px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Error State */
    .error-message {
      background: #f8d7da;
      color: #721c24;
      padding: 16px 20px;
      border-radius: var(--radius-sm);
      margin: 20px 0;
      border: 1px solid #f5c6cb;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }

      .header {
        padding: 15px 20px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .prediction-table th,
      .prediction-table td {
        padding: 12px 16px;
        font-size: 14px;
      }

      .chart-container {
        height: 300px;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <h1>üìä Demand Prediction Analysis</h1>
      <a href="sales-report.html" class="back-btn">‚Üê Back to Sales Report</a>
    </div>
  </header>

  <!-- Main Container -->
  <div class="container">
    <!-- Stats Overview -->
    <div class="stats-grid" id="statsGrid">
      <!-- Stats will be loaded here -->
    </div>

    <!-- Prediction Table -->
    <div class="prediction-section">
      <div class="section-header">
        <h2>Item-by-Item Prediction Analysis</h2>
      </div>
      <div class="table-container">
        <table class="prediction-table">
          <thead>
            <tr>
              <th>Item Name</th>
              <th>Category</th>
              <th>Actual Sales (Last 7 Days)</th>
              <th>Predicted Demand</th>
              <th>Variance</th>
              <th>Trend</th>
              <th>Accuracy</th>
            </tr>
          </thead>
          <tbody id="predictionTableBody">
            <!-- Data will be loaded here -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Comparison Chart -->
    <div class="chart-section">
      <h2>Actual vs Predicted Demand Comparison</h2>
      <div class="chart-container">
        <canvas id="comparisonChart"></canvas>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'http://127.0.0.1:5001'; // Demand prediction API server
    let comparisonChart = null;
    
    // Fetch real data from backend
    async function fetchPredictionData() {
      try {
        const response = await fetch(`${API_BASE}/api/demand/predictions`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return await response.json();
      } catch (error) {
        console.error('Failed to fetch prediction data:', error);
        // Return fallback data structure
        return {
          stats: {
            totalItems: 0,
            avgAccuracy: 0,
            bestPerformer: "No data",
            worstPerformer: "No data"
          },
          predictions: []
        };
      }
    }

    async function loadStats() {
      const statsGrid = document.getElementById('statsGrid');
      
      try {
        const data = await fetchPredictionData();
        const stats = data.stats;
        
        statsGrid.innerHTML = `
          <div class="stat-card">
            <h3>Total Items Tracked</h3>
            <div class="stat-value">${stats.totalItems}</div>
            <div class="stat-change positive">Active predictions</div>
          </div>
          <div class="stat-card">
            <h3>Average Accuracy</h3>
            <div class="stat-value">${stats.avgAccuracy}%</div>
            <div class="stat-change ${stats.accuracyTrend > 0 ? 'positive' : 'negative'}">
              ${stats.accuracyTrend > 0 ? '+' : ''}${stats.accuracyTrend}% from last week
            </div>
          </div>
          <div class="stat-card">
            <h3>Best Performer</h3>
            <div class="stat-value">${stats.bestPerformer}</div>
            <div class="stat-change positive">${stats.bestAccuracy}% accuracy</div>
          </div>
          <div class="stat-card">
            <h3>Needs Attention</h3>
            <div class="stat-value">${stats.worstPerformer}</div>
            <div class="stat-change negative">${stats.worstAccuracy}% accuracy</div>
          </div>
        `;
      } catch (error) {
        statsGrid.innerHTML = `
          <div class="error-message">
            Failed to load statistics. Please ensure the prediction server is running.
          </div>
        `;
      }
    }

    async function loadPredictionTable() {
      const tbody = document.getElementById('predictionTableBody');
      
      try {
        const data = await fetchPredictionData();
        const predictions = data.predictions;
      
      tbody.innerHTML = predictions.map(item => {
        const variance = item.predictedDemand - item.actualSales;
        const variancePercent = Math.abs((variance / item.actualSales) * 100).toFixed(1);
        const accuracyClass = item.accuracy >= 85 ? 'accuracy-high' : 
                             item.accuracy >= 70 ? 'accuracy-medium' : 'accuracy-low';
        
        const trendIcon = item.trend === 'up' ? '‚ÜóÔ∏è' : 
                         item.trend === 'down' ? '‚ÜòÔ∏è' : '‚û°Ô∏è';
        
        const trendClass = `trend-${item.trend}`;
        
        return `
          <tr>
            <td class="item-name">${item.name}</td>
            <td>
              <span class="category-badge category-${item.category.toLowerCase()}">
                ${item.category}
              </span>
            </td>
            <td class="sales-number">${item.actualSales}</td>
            <td class="prediction-number">${item.predictedDemand}</td>
            <td>
              <span class="${variance >= 0 ? 'trend-up' : 'trend-down'}">
                ${variance > 0 ? '+' : ''}${variance} (${variancePercent}%)
              </span>
            </td>
            <td>
              <span class="trend-arrow ${trendClass}">${trendIcon}</span>
            </td>
            <td>
              <div class="accuracy-indicator">
                <div class="accuracy-bar">
                  <div class="accuracy-fill ${accuracyClass}" 
                       style="width: ${item.accuracy}%"></div>
                </div>
                <span>${item.accuracy}%</span>
              </div>
            </td>
          </tr>
        `;
      }).join('');
      
      } catch (error) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" style="text-align: center; padding: 40px;">
              <div class="error-message">
                Failed to load prediction data. Please ensure the prediction server is running.
              </div>
            </td>
          </tr>
        `;
      }
    }

    async function loadComparisonChart() {
      const ctx = document.getElementById('comparisonChart');
      
      try {
        const data = await fetchPredictionData();
        const predictions = data.predictions;
      
      if (comparisonChart) comparisonChart.destroy();
      
      comparisonChart = new Chart(ctx.getContext('2d'), {
        type: 'bar',
        data: {
          labels: predictions.map(item => item.name),
          datasets: [
            {
              label: 'Actual Sales',
              data: predictions.map(item => item.actualSales),
              backgroundColor: 'rgba(225, 70, 50, 0.8)',
              borderColor: 'rgba(225, 70, 50, 1)',
              borderWidth: 1
            },
            {
              label: 'Predicted Demand',
              data: predictions.map(item => item.predictedDemand),
              backgroundColor: 'rgba(54, 162, 235, 0.8)',
              borderColor: 'rgba(54, 162, 235, 1)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Actual Sales vs Predicted Demand (Last 7 Days)'
            },
            legend: {
              position: 'top',
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Quantity'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Menu Items'
              }
            }
          },
          interaction: {
            intersect: false,
            mode: 'index'
          }
        }
      });
      
      } catch (error) {
        console.error('Error loading comparison chart:', error);
        ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
      }
    }

    // Initialize page
    async function initializePage() {
      try {
        await loadStats();
        await loadPredictionTable();
        await loadComparisonChart();
      } catch (error) {
        console.error('Error loading demand prediction data:', error);
        document.querySelector('.container').insertAdjacentHTML('afterbegin', 
          '<div class="error-message">Error loading prediction data. Please try again.</div>'
        );
      }
    }

    // Load data when page loads
    window.addEventListener('load', initializePage);
  </script>
</body>
</html>